<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adicionar Novo Ponto de Coleta - EcoPronto</title>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    #mapa {
      height: 300px;
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <header>
    <h2>EcoPronto</h2>
    <nav>
      <a href="index.html">Página Inicial</a>
      <a href="pontos.html">Pontos</a>
      <a href="login.html" class="btn btn-primary">Entrar</a>
    </nav>
  </header>

  <main class="section" style="max-width: 900px; margin: 0 auto;">
    <h1 style="font-size: 2rem; font-weight: 900; margin-bottom: 2rem;">
      Adicionar Novo Ponto de Coleta
    </h1>

    <form id="formAdicionarPonto">
      <section class="card" style="margin-bottom: 2rem;">
        <h3>Informações do Ponto</h3>

        <label>
          <p>Nome do Ponto</p>
          <input type="text" name="nome_ponto" placeholder="Digite o nome do ponto de coleta" required>
        </label>

        <label>
          <p>Descrição / Observações</p>
          <textarea name="descricao" placeholder="Adicione uma descrição ou observações relevantes"></textarea>
        </label>

        <label>
          <p>Telefone (Opcional)</p>
          <input type="tel" name="telefone" placeholder="(XX) XXXXX-XXXX">
        </label>
      </section>

      <section class="card" style="margin-bottom: 2rem;">
        <h3>Endereço</h3>

        <label>
          <p>Rua / Logradouro</p>
          <input type="text" name="logradouro" id="campo_logradouro" placeholder="Rua, Avenida, etc." required>
        </label>

        <div style="display:flex; gap:1rem; margin-bottom:1rem;">
          <label style="flex-grow:1;">
            <p>Número</p>
            <input type="text" name="numero" id="campo_numero" placeholder="Ex: 123">
          </label>

          <label style="flex-grow:1;">
            <p>CEP</p>
            <input type="text" name="cep" id="campo_cep" placeholder="00000-000" required>
          </label>
        </div>

        <div style="display:flex; gap:1rem;">
          <label style="flex:1;">
            <p>Cidade</p>
            <input type="text" name="cidade" id="campo_cidade" placeholder="Ex: São Paulo" required>
          </label>
          <label style="flex:1;">
            <p>Estado</p>
            <input type="text" name="estado" id="campo_estado" placeholder="Ex: SP">
          </label>
        </div>

        <p style="margin-top: 1.5rem;">Localização Exata no Mapa (Arraste o marcador)</p>
        <div id="mapa"></div>

        <input type="hidden" name="latitude" id="input_latitude" required>
        <input type="hidden" name="longitude" id="input_longitude" required>
      </section>

      <section class="card" style="margin-bottom: 2rem;">
        <h3>Tipos de Resíduos Aceitos</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:1rem;">
          <label><input type="checkbox" name="residuos" value="Plástico"> Plástico</label>
          <label><input type="checkbox" name="residuos" value="Vidro"> Vidro</label>
          <label><input type="checkbox" name="residuos" value="Metal"> Metal</label>
          <label><input type="checkbox" name="residuos" value="Papel"> Papel</label>
          <label><input type="checkbox" name="residuos" value="Eletrônicos"> Eletrônicos</label>
          <label><input type="checkbox" name="residuos" value="Baterias"> Baterias</label>
          <label><input type="checkbox" name="residuos" value="Orgânico"> Orgânico</label>
          <label><input type="checkbox" name="residuos" value="Óleo de Cozinha"> Óleo de Cozinha</label>
        </div>
      </section>

      <div style="display:flex; justify-content:flex-end; gap:1rem;">
        <a href="pontos.html" class="btn btn-outline">Cancelar</a>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>
    </form>
  </main>

  <footer>
    <p>© 2025 EcoPronto — Todos os direitos reservados.</p>
  </footer>

  <!-- Google Maps -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMli7nuu86koVtaKxELL1tfv-yo3c2H8o&callback=initMap">
    </script>

  <script>
    const LAT_INICIAL = -23.55052;
    const LNG_INICIAL = -46.63330;

    let map, marker, geocoder;

    function initMap() {
      geocoder = new google.maps.Geocoder();

      map = new google.maps.Map(document.getElementById("mapa"), {
        zoom: 12,
        center: { lat: LAT_INICIAL, lng: LNG_INICIAL },
        mapTypeControl: false,
        streetViewControl: false
      });

      marker = new google.maps.Marker({
        position: { lat: LAT_INICIAL, lng: LNG_INICIAL },
        map,
        draggable: true,
        title: "Arraste para definir o local"
      });

      document.getElementById('input_latitude').value = LAT_INICIAL.toFixed(6);
      document.getElementById('input_longitude').value = LNG_INICIAL.toFixed(6);

      marker.addListener("dragend", () => {
        const pos = marker.getPosition();
        document.getElementById('input_latitude').value = pos.lat().toFixed(6);
        document.getElementById('input_longitude').value = pos.lng().toFixed(6);
      });

      // --- Função para atualizar o mapa ao digitar endereço ---
      let enderecoTimeout = null;

      function atualizarMapaPeloEndereco() {
        clearTimeout(enderecoTimeout);

        enderecoTimeout = setTimeout(() => {
          const rua = document.getElementById("campo_logradouro").value || "";
          const numero = document.getElementById("campo_numero").value || "";
          const cidade = document.getElementById("campo_cidade").value || "";
          const estado = document.getElementById("campo_estado").value || "";
          const cep = document.getElementById("campo_cep").value || "";

          const enderecoCompleto = `${rua} ${numero}, ${cidade} - ${estado}, ${cep}`.trim();

          if (enderecoCompleto.length < 5) return;

          geocoder.geocode({ address: enderecoCompleto }, (results, status) => {
            if (status === "OK" && results[0]) {
              const pos = results[0].geometry.location;

              map.panTo(pos);
              map.setZoom(16);
              marker.setPosition(pos);

              document.getElementById("input_latitude").value = pos.lat().toFixed(6);
              document.getElementById("input_longitude").value = pos.lng().toFixed(6);
            }
          });
        }, 600); // aguarda 600ms após parar de digitar
      }
    }

    function atualizarMapaPeloEndereco() {
      const rua = document.getElementById("campo_logradouro").value || "";
      const numero = document.getElementById("campo_numero").value || "";
      const cidade = document.getElementById("campo_cidade").value || "";
      const estado = document.getElementById("campo_estado").value || "";
      const cep = document.getElementById("campo_cep").value || "";

      const enderecoCompleto = `${rua} ${numero}, ${cidade}, ${estado}, ${cep}`;

      geocoder.geocode({ address: enderecoCompleto }, (results, status) => {
        if (status === "OK" && results[0]) {
          const pos = results[0].geometry.location;

          map.setCenter(pos);
          marker.setPosition(pos);

          document.getElementById("input_latitude").value = pos.lat().toFixed(6);
          document.getElementById("input_longitude").value = pos.lng().toFixed(6);
        }
      });
    }

    // --- ENVIO DO FORMULÁRIO ---
    document.getElementById('formAdicionarPonto').addEventListener('submit', async (event) => {
      event.preventDefault();

      const formData = new FormData(event.target);
      const dados = {};

      for (const [key, value] of formData.entries()) {
        if (key !== 'residuos') dados[key] = value;
      }

      dados.residuos = [];
      event.target.querySelectorAll('input[name="residuos"]:checked')
        .forEach(cb => dados.residuos.push(cb.value));

      dados.nome = dados.nome_ponto;
      dados.endereco = `${dados.logradouro || ""}, ${dados.numero || ""}`;
      delete dados.nome_ponto;
      delete dados.logradouro;
      delete dados.numero;
      delete dados.cep;

      try {
        const resp = await fetch('/api/pontos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.error || 'Erro ao salvar ponto.');
        }

        alert('Ponto de coleta adicionado com sucesso!');
        window.location.href = 'pontos.html';
      } catch (err) {
        console.error('Erro:', err);
        alert('Falha ao adicionar ponto: ' + err.message);
      }
    });
  </script>
</body>

</html>